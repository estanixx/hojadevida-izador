name: AWS deploy workflow
on:
  workflow_dispatch: # Esto habilita el botón manual
    inputs:
      reason:
        description: 'Razón del despliegue manual'
        required: false
        default: 'Actualización rápida'
  push:
    branches:
      - prod
    paths:
      - 'frontend/**'
      - 'infrastructure/**'
      - '.github/workflows/deploy.yml'
env:
  ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_ARN }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  REPO_NAME: my-frontend-app
permissions:
  id-token: write
  contents: read
jobs:
  # 1. Create or update CloudFormation stack for network infrastructure (if changed)
  deploy-network-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }} # Adjust to your specific region

      - name: Deploy CloudFormation Stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: my-network-infrastructure-stack
          template: infrastructure/network-setup.yaml
          capabilities: CAPABILITY_NAMED_IAM
          no-fail-on-empty-changeset: "1" 

  # 3. Update frontend container definition and trigger ECS deployment (if changed)
  deploy-frontend:
    needs:  deploy-network-infrastructure
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect frontend changes (push)
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        id: filter_push
        with:
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            frontend:
              - 'frontend/**'

      - name: Mark frontend as changed (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: filter_manual
        run: echo "frontend=true" >> "$GITHUB_OUTPUT"

      - name: Normalize frontend change output
        id: filter
        run: |
          FRONTEND_CHANGED="${{ steps.filter_push.outputs.frontend || steps.filter_manual.outputs.frontend || 'false' }}"
          echo "frontend=$FRONTEND_CHANGED" >> "$GITHUB_OUTPUT"
          echo "frontend_changed=$FRONTEND_CHANGED"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{env.ROLE_TO_ASSUME}}
          aws-region: ${{ env.AWS_REGION }} # Adjust to your specific region

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get Current Image URI
        if: steps.filter.outputs.frontend == 'false'
        id: get-current
        run: |
          # Use AWS CLI to find the image currently in the Task Definition
          REPO_NAME="${{ env.REPO_NAME }}"
          REGISTRY_ID=$(aws ecr describe-registry --query 'registryId' --output text)
          
          LAST_IMAGE_TAG=$(aws ecr describe-images \
            --repository-name $REPO_NAME \
            --query 'sort_by(imageDetails, &imagePushedAt)[-1].imageTags[0]' \
            --output text 2>/dev/null || echo "")

          if [ -z "$LAST_IMAGE_TAG" ] || [ "$LAST_IMAGE_TAG" == "None" ]; then
            echo "image_found=false" >> $GITHUB_OUTPUT
            echo "No se encontraron imágenes en el repositorio ECR: $REPO_NAME"
          else
            # Construimos la URI completa
            FULL_URI="${{ steps.login-ecr.outputs.registry }}/$REPO_NAME:$LAST_IMAGE_TAG"
            echo "image=$FULL_URI" >> $GITHUB_OUTPUT
            echo "image_found=true" >> $GITHUB_OUTPUT
            echo "Última imagen encontrada en ECR: $FULL_URI"
          fi
          echo "${{steps.filter.outputs.frontend}}"

      - name: Build, Tag, and Push Image to ECR
        if: steps.filter.outputs.frontend == 'true' || steps.get-current.outputs.image_found == 'false'
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.REPO_NAME }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Only build if frontend files changed (optional optimization)
          docker build -f ./frontend/Dockerfile.prod -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./frontend
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      - name: Deploy CloudFormation Stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: my-frontend-stack
          template: infrastructure/frontend-setup.yaml
          parameter-overrides: >-
            ECRImageUri=${{ steps.build-image.outputs.image || steps.get-current.outputs.image }}
          capabilities: CAPABILITY_NAMED_IAM
          no-fail-on-empty-changeset: "1" 